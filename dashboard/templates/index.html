<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프리미엄 의료 RAG 대시보드</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --glass-blur: blur(12px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            word-break: keep-all;
            /* 한글 줄바꿈 최적화 */
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: var(--text-main);
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden;
        }

        /* 배경 장식 */
        .bg-glow {
            position: fixed;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            top: -100px;
            right: -100px;
            z-index: -1;
            pointer-events: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* 헤더 스타일 */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .logo-section h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(to right, #6366f1, #a855f7);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.025em;
        }

        .logo-section p {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .status-header {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .reconcile-indicator {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background-color: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* 카드 그리드 */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border);
            border-radius: 1.25rem;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .stat-card .label {
            color: var(--text-dim);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .stat-card .sub-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 5px;
            display: block;
        }

        /* 헬스 등급 디자인 */
        .health-summary {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .health-mini-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }

        .grade-S {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .grade-A {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .grade-B {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .grade-F {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        /* 차트 영역 */
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            height: 300px;
            width: 100%;
        }

        /* 테이블 영역 */
        .table-section {
            margin-top: 2rem;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-main);
            outline: none;
            transition: all 0.2s;
        }

        .search-box input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
        }

        .filters {
            display: flex;
            gap: 1rem;
        }

        .filters select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-main);
            outline: none;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem;
        }

        th {
            text-align: left;
            color: var(--text-dim);
            font-weight: 500;
            font-size: 0.8rem;
            padding: 0 1rem 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tbody tr {
            background: rgba(255, 255, 255, 0.02);
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        td {
            padding: 1rem;
        }

        td:first-child {
            border-top-left-radius: 0.75rem;
            border-bottom-left-radius: 0.75rem;
        }

        td:last-child {
            border-top-right-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }

        .video-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .video-thumb {
            width: 80px;
            height: 45px;
            border-radius: 0.4rem;
            object-fit: cover;
            background: #1e293b;
        }

        .video-info h4 {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.2rem;
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-info span {
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9991px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-completed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .badge-failed {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .badge-processing {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-main);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-action:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* 페이지네이션 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .pagination button {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* 모달 스타일 */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
        }

        .modal-content {
            background: var(--bg);
            width: 100%;
            max-width: 900px;
            border-radius: 1.5rem;
            border: 1px solid var(--border);
            overflow: hidden;
            animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 75vh;
            overflow-y: auto;
        }

        .summary-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 1rem;
            margin: 1.5rem 0;
            line-height: 1.6;
            border-left: 4px solid var(--primary);
        }

        .chunk-list {
            display: grid;
            gap: 1rem;
        }

        .chunk-item {
            border: 1px solid var(--border);
            padding: 1rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.01);
        }

        .chunk-item h5 {
            color: var(--primary-light);
            margin-bottom: 0.5rem;
        }

        .chunk-item p {
            font-size: 0.9rem;
            color: #cbd5e1;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* 스켈레톤 로딩 애니메이션 */
        .skeleton {
            background: linear-gradient(90deg, var(--card-bg) 25%, rgba(255, 255, 255, 0.05) 50%, var(--card-bg) 75%);
            background-size: 200% 100%;
            animation: skeletonPulse 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeletonPulse {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 2rem;
            width: 80px;
            display: inline-block;
        }

        .skeleton-chart {
            height: 200px;
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="bg-glow"></div>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo-section">
                <h1>Medical RAG Analytics</h1>
                <p>의료 연구 어시스턴트 재단 | AI 인텔리전스 대시보드</p>
            </div>
            <div class="status-header">
                <div class="reconcile-indicator">
                    <div class="pulse-dot"></div>
                    데이터베이스 연결됨
                </div>
                <div id="lastUpdated" style="font-size: 0.8rem; color: var(--text-dim);">
                    마지막 동기화: {{ last_updated }}
                </div>
            </div>
        </header>

        <!-- Stats Overview -->
        <div class="stat-grid">
            <div class="glass-card stat-card">
                <div class="label">총 수집 비디오</div>
                <div class="value" id="count-total">{{ total_videos }}</div>
                <div class="sub-label">전체 19개 의료 채널 분석</div>
            </div>
            <div class="glass-card stat-card">
                <div class="label">데이터 품질 (Health)</div>
                <div class="health-summary" id="health-summary">
                    <span class="health-mini-badge grade-S">S: 0</span>
                    <span class="health-mini-badge grade-A">A: 0</span>
                    <span class="health-mini-badge grade-B">B: 0</span>
                    <span class="health-mini-badge grade-F">F: 0</span>
                </div>
                <div id="progress-bar-label" class="sub-label">처리 성공률: 0%</div>
            </div>
            <div class="glass-card stat-card">
                <div class="label">R2 스토리지 사용량</div>
                <div class="value" id="count-storage" style="color: #a855f7;">0 MB</div>
                <div class="sub-label" id="count-chunks">청크: {{ r2_stats.chunks.count }} 개</div>
            </div>
            <div class="glass-card stat-card">
                <div class="label">벡터 인덱스 수</div>
                <div class="value" id="count-vectors">{{ pinecone_stats.total_vectors }}</div>
                <div class="sub-label">고차원 임베딩 (Pinecone)</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="chart-grid">
            <div class="glass-card">
                <div class="label" style="margin-bottom: 1.5rem;">데이터 수집 추이 (일별)</div>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
            <div class="glass-card">
                <div class="label" style="margin-bottom: 1.5rem;">채널별 수집 분포</div>
                <div class="chart-container">
                    <canvas id="distChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Video List Section -->
        <section class="table-section">
            <div class="table-header">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by title or video ID..."
                        oninput="handleSearch()">
                </div>
                <div class="filters">
                    <select id="channelFilter" onchange="handleFilter()">
                        <option value="">전체 채널</option>
                    </select>
                    <button class="btn-action" onclick="refreshData()">DB 동기화</button>
                </div>
            </div>

            <div class="glass-card" style="padding: 0;">
                <div style="overflow-x: auto;">
                    <table id="videoTable">
                        <thead>
                            <tr>
                                <th>비디오 메타데이터</th>
                                <th>상태</th>
                                <th>청크 수</th>
                                <th>데이터 무결성</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="videoListBody">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
                <div id="loadingIndicator" class="loading-state"
                    style="padding: 3rem; text-align: center; color: var(--text-dim); display: none;">
                    최신 데이터를 불러오고 있습니다...
                </div>
            </div>

            <div class="pagination">
                <button id="prevBtn" onclick="prevPage()">이전</button>
                <div id="pageIndicator" style="font-size: 0.9rem; color: var(--text-dim);">Page 1 of 1</div>
                <button id="nextBtn" onclick="nextPage()">다음</button>
            </div>
        </section>

        <footer>
            <p
                style="text-align: center; color: var(--text-dim); font-size: 0.8rem; margin-top: 4rem; padding-bottom: 2rem;">
                © 2026 Medical RAG Infrastructure | 자동화된 유튜브 의료 인텔리전스 시스템
            </p>
        </footer>
    </div>

    <!-- Video Detail Modal -->
    <div class="modal-overlay" id="videoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">비디오 인텔리전스 상세</h3>
                <button onclick="closeModal()"
                    style="background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <script>
        // State
        let currentPage = 1;
        let totalPages = 1;
        let selectedChannel = '';
        let searchQuery = '';
        let trendsChart, distChart;

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadChannels();
            refreshData();
            // Start Auto-polling (every 30 seconds)
            setInterval(refreshData, 30000);
        });

        async function refreshData() {
            // 스켈레톤 상태 표시 (선택적)
            // showSkeletons();

            try {
                // API 병렬 호출로 체감 속도 향상
                const [statusResp, analysisResp] = await Promise.all([
                    fetch('/api/status'),
                    fetch('/api/stats/analysis')
                ]);

                const statusData = await statusResp.json();
                const analysisData = await analysisResp.json();

                // UI 즉시 업데이트
                updateStats(statusData);
                updateCharts(analysisData);
                loadVideos();
                updateSyncTime();
            } catch (error) {
                console.error("Critical: Failed to sync with backend.", error);
            }
        }

        function updateStats(data) {
            document.getElementById('count-total').innerText = data.total_videos;

            // Storage Stats
            const totalSize = (data.r2_stats.transcripts.size_bytes + data.r2_stats.chunks.size_bytes + data.r2_stats.metadata.size_bytes);
            document.getElementById('count-storage').innerText = formatBytes(totalSize);
            document.getElementById('count-chunks').innerText = `청크: ${data.r2_stats.chunks.count} 개`;

            document.getElementById('count-vectors').innerText = data.pinecone_stats.total_vectors;
            const rate = ((data.completed / data.total_videos) * 100).toFixed(1);
            document.getElementById('progress-bar-label').innerText = `처리 성공률: ${rate}%`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateCharts(data) {
            // Trends Chart
            if (data.trends && data.trends.length > 0) {
                trendsChart.data.labels = data.trends.map(t => t.day.slice(5));
                trendsChart.data.datasets[0].data = data.trends.map(t => t.count);
                trendsChart.update();
            }

            // Dist Chart
            if (data.distribution && data.distribution.length > 0) {
                const topDist = data.distribution.slice(0, 5);
                distChart.data.labels = topDist.map(t => t.channel.slice(0, 10) + '...');
                distChart.data.datasets[0].data = topDist.map(t => t.count);
                distChart.update();
            }

            // Health Summary
            if (data.health) {
                const h = data.health;
                document.getElementById('health-summary').innerHTML = `
                    <span class="health-mini-badge grade-S">S: ${h.S || 0}</span>
                    <span class="health-mini-badge grade-A">A: ${h.A || 0}</span>
                    <span class="health-mini-badge grade-B">B: ${h.B || 0}</span>
                    <span class="health-mini-badge grade-F">F: ${h.F || 0}</span>
                `;
            }
        }

        // 레거시 호환성 유지
        async function loadAnalysis() {
            try {
                const resp = await fetch('/api/stats/analysis');
                const data = await resp.json();
                updateCharts(data);
            } catch (e) {
                console.error('Analysis load failed', e);
            }
        }

        async function loadChannels() {
            const resp = await fetch('/api/channels');
            const data = await resp.json();
            const filter = document.getElementById('channelFilter');
            data.channels.forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch;
                opt.textContent = ch;
                filter.appendChild(opt);
            });
        }

        async function loadVideos() {
            const container = document.getElementById('videoListBody');
            const loader = document.getElementById('loadingIndicator');

            loader.style.display = 'block';

            try {
                let url = `/api/videos?page=${currentPage}&per_page=10`;
                if (selectedChannel) url += `&channel=${encodeURIComponent(selectedChannel)}`;

                const resp = await fetch(url);
                const data = await resp.json();

                currentPage = data.pagination.page;
                totalPages = data.pagination.total_pages;
                document.getElementById('pageIndicator').innerText = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prevBtn').disabled = !data.pagination.has_prev;
                document.getElementById('nextBtn').disabled = !data.pagination.has_next;

                container.innerHTML = data.videos.map(v => {
                    // Simple logic for grade visualization in list
                    let grade = 'B';
                    if (v.status === 'completed' && v.chunk_count > 0 && v.summary) grade = 'S';
                    else if (v.status === 'completed') grade = 'A';
                    else if (v.status === 'failed') grade = 'F';

                    return `
                    <tr>
                        <td>
                            <div class="video-meta">
                                <img src="${v.thumbnail_url || 'https://via.placeholder.com/80x45'}" class="video-thumb" loading="lazy">
                                <div class="video-info">
                                    <h4>${v.title}</h4>
                                    <span>${v.channel_name} | ID: ${v.video_id}</span>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge badge-${v.status}">${v.status.toUpperCase()}</span></td>
                        <td><span style="font-family: monospace;">${v.chunk_count}</span></td>
                        <td><span class="health-mini-badge grade-${grade}">Grade ${grade}</span></td>
                        <td><button class="btn-action" onclick="showDetail('${v.video_id}')">상세분석</button></td>
                    </tr>
                `}).join('');
            } catch (err) {
                console.error("Video load failed", err);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function showDetail(videoId) {
            const modal = document.getElementById('videoModal');
            const body = document.getElementById('modalBody');
            modal.style.display = 'flex';
            body.innerHTML = '<div style="text-align:center; padding: 2rem;">세그먼트 및 메타데이터를 불러오는 중...</div>';

            try {
                const resp = await fetch(`/api/video/${videoId}`);
                const v = await resp.json();

                body.innerHTML = `
                    <div style="display:flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 2rem;">
                        <img src="${v.thumbnail_url}" style="width: 100%; max-width: 380px; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);">
                        <div style="flex: 1; min-width: 300px;">
                            <h2 style="font-size: 1.5rem; margin-bottom: 0.75rem; color: var(--text-main); line-height: 1.3;">${v.title}</h2>
                            <p style="color: var(--text-dim); margin-bottom: 1.5rem; display: flex; align-items:center; gap: 10px;">
                                <span>게시일: ${v.published_at}</span>
                                <span style="color: var(--border)">|</span>
                                <span>ID: ${v.video_id}</span>
                            </p>
                            <div style="display:flex; gap: 10px; align-items:center;">
                                <span class="badge badge-${v.status}">${v.status.toUpperCase()}</span>
                                <a href="https://youtube.com/watch?v=${v.video_id}" target="_blank" class="btn-action" style="display:inline-block; text-decoration: none;">유튜브 바로가기</a>
                            </div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="glass-card" style="padding: 1.25rem;">
                            <h4 style="color: var(--primary-light); margin-bottom: 0.75rem; font-size: 0.9rem;">인텔리전스 요약</h4>
                            <p style="color: var(--text-main); line-height: 1.6; font-size: 0.95rem;">${v.summary || '요약 정보가 없습니다.'}</p>
                        </div>
                        <div class="glass-card" style="padding: 1.25rem;">
                            <h4 style="color: var(--success); margin-bottom: 0.75rem; font-size: 0.9rem;">처리 스펙</h4>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                                <div style="color: var(--text-dim)">총 청크 수:</div><div>${v.chunk_count}</div>
                                <div style="color: var(--text-dim)">트랜스크립트:</div><div style="color: var(--success)">검증됨</div>
                                <div style="color: var(--text-dim)">동기화 상태:</div><div style="color: var(--warning)">읽기 전용</div>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin-bottom: 1rem; display:flex; align-items:center; gap: 10px;">
                        데이터 세그먼트 (Chunks)
                        <span style="font-size: 0.8rem; font-weight: 400; color: var(--text-dim);">인덱싱된 벡터 데이터 미리보기</span>
                    </h4>
                    <div class="chunk-list">
                        ${v.chunks.map(c => `
                            <div class="chunk-item">
                                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <h5 style="font-size: 0.9rem; margin: 0;">#세그먼트 ${c.chunk_index}</h5>
                                    <span style="font-size: 0.75rem; color: var(--primary-light); background: rgba(99,102,241,0.1); padding: 2px 8px; border-radius: 4px;">타임코드: ${c.start_time}s - ${c.end_time}s</span>
                                </div>
                                <p style="margin-bottom: 0.75rem; color: var(--text-dim); font-style: italic; font-size: 0.85rem; padding-left: 10px; border-left: 2px solid var(--border);">
                                    컨텍스트: "${c.context}"
                                </p>
                                <p style="font-size: 0.95rem; color: #e2e8f0; line-height: 1.5;">${c.text}</p>
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    ${c.topics.map(t => `<span style="border: 1px solid rgba(99,102,241,0.2); color: var(--primary-light); font-size: 0.65rem; padding: 1px 6px; border-radius: 4px; text-transform: lowercase;">#${t}</span>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                body.innerHTML = '<div style="color:var(--error); padding: 2rem; text-align:center;">세그먼트 데이터를 불러오는데 실패했습니다.</div>';
            }
        }

        function initCharts() {
            const ctxTrends = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(ctxTrends, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '수집된 비디오',
                        data: [],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { border: { display: false }, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                        x: { border: { display: false }, grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });

            const ctxDist = document.getElementById('distChart').getContext('2d');
            distChart = new Chart(ctxDist, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#6366f1', '#a855f7', '#ec4899', '#f59e0b', '#10b981'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#94a3b8',
                                boxWidth: 10,
                                padding: 20,
                                font: { size: 11 }
                            }
                        }
                    },
                    cutout: '75%'
                }
            });
        }

        function handleFilter() {
            selectedChannel = document.getElementById('channelFilter').value;
            currentPage = 1;
            loadVideos();
        }

        function handleSearch() {
            searchQuery = document.getElementById('searchInput').value;
            // TODO: Server-side search logic if needed
        }

        function prevPage() { if (currentPage > 1) { currentPage--; loadVideos(); } }
        function nextPage() { if (currentPage < totalPages) { currentPage++; loadVideos(); } }
        function closeModal() { document.getElementById('videoModal').style.display = 'none'; }
        function updateSyncTime() {
            document.getElementById('lastUpdated').innerText = `마지막 동기화: ${new Date().toLocaleTimeString()}`;
        }
    </script>
</body>

</html>